#src/main/resources/application-dev.yml
server:
  port: 8080
  address: 0.0.0.0

spring:
  task:
    scheduling:
      pool:
        size: 6                 # 由 2 提升到 6：promotion/purge/retention 等可並行
      thread-name-prefix: "sched-"
      shutdown:
        await-termination: true
        await-termination-period: 30s
    # 若你偏好全局設定時區（依 Boot 版本），也可加上（仍建議註解端顯式 zone 保險）
    # time-zone: Asia/Taipei
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3307/calai?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&characterEncoding=utf8&createDatabaseIfNotExist=true
    username: root
    password: root

  jpa:
    hibernate:
      ddl-auto: none             # 無自動建表；請用 Flyway/Liquibase
    open-in-view: false
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        jdbc:
          time_zone: UTC         # 與 DB 溝通用 UTC

  data:
    redis:
      host: localhost
      port: 6379

  mail:
    host: smtp.gmail.com
    port: 587
    test-connection: true
    username: "${SMTP_USERNAME}"
    password: "${SMTP_PASSWORD}"
    properties:
      mail.transport.protocol: smtp
      mail.smtp.auth: true
      mail.smtp.starttls.enable: true
      mail.smtp.starttls.required: true   # 建議加上
      mail.smtp.connectiontimeout: 5000   # (ms) 避免連線卡死
      mail.smtp.timeout: 5000
      mail.smtp.writetimeout: 5000
    default-encoding: UTF-8

management:
  endpoints:
    web:
      exposure:
        include: health,info,scheduledtasks
  endpoint:
    health:
      show-details: when_authorized

app:
  actuator:
    user: "${APP_ACTUATOR_USER:actuator}"
    pass: "${APP_ACTUATOR_PASS:change-me}"
  foodlog:
    provider: "GEMINI"  # STUB / TODO 正式環境改 : GEMINI
  provider:
    gemini:
      enabled: true
      api-key: "${GEMINI_API_KEY}"
      base-url: "https://generativelanguage.googleapis.com"
      model: "gemini-3-flash-preview"
      connect-timeout: 5s
      read-timeout: 30s
      max-output-tokens: 1024
      temperature: 1.0
  features:
    dev-image-endpoint: true
    dev-debug-endpoints: true
  google:
    play:
      enabled: true
      package-name: "com.calai.app"
      service-account-json-path: "${GOOGLE_PLAY_BITE_CAL_SA_JSON_PATH:}"  # dev 可用
    web-client-id: "${GOOGLE_WEB_CLIENT_ID_DEV:575775859979-nuhb6lmchca4sn5719193uke61eda7pq.apps.googleusercontent.com}"
  billing:
    products:
      monthly: [ "bitecal_monthly" ]
      yearly: [ "bitecal_yearly" ]
  auth:
    access-ttl-sec: 900
    refresh-ttl-sec: 2592000
  security:
    allow-origins: "*"
  email:
    enabled: true
    otp-length: 4
    ttl-minutes: 10
    # 若使用 Gmail SMTP，from 最好等於 username；否則容易被覆寫或遭拒收
    sender: "st9360606@gmail.com"
    # 若要用自家網域 no-reply@bitecal.app，建議改用 SendGrid/SES 並設定 SPF/DKIM/DMARC
  storage:
    weight-photos-dir: uploads/weight-photos
    local:
      base-dir: ./data # TODO 要排程刪除
      tmp-cleaner:
        enabled: true
        tmp-subdir: "blobs/tmp"     # 相對於 base-dir  cleaner 只會掃描 base-dir/tmp-subdir 子樹，並做 tmpDir.startsWith(baseDir) 防呆，避免配置錯誤誤刪其他路徑。建議 production 若改用雲端 object storage，可直接 enabled=false 關閉。
        keep: "PT6H"                # 超過 6 小時的 tmp 檔會刪
        fixed-delay: "PT10M"        # 每 10 分鐘跑一次
        initial-delay: "PT1M"       # 啟動後 1 分鐘第一次執行
        max-depth: 8                # 避免深層走訪拖慢
        delete-empty-dirs: true

  retention:
    foodlog:
      enabled: true           #FoodLogRetentionWorker
      keep-draft: "PT72H"     # 3 天
      keep-saved: "PT768H"    # 32 天
      batch-size: 200
      purge-after: "PT168H"   # 可選：DELETED 後 7 天再做 hard purge（下一步）

  account-deletion:
    worker:
      enabled: true
      claim-limit: 5
      per-table-delete-limit: 500
      food-batch: 200
      check-interval: "PT30S"
      base-retry-delay: "PT10S"

alias:
  promotion:
    # 不再用 cron（避免 */3 的曆法語意），改 72h 固定延遲
    fixedDelay: "PT72H"
    initialDelay: "PT5M"
    windowDays: 30
    minUsers: 3
    minCount: 7
    minMedian: 0.88

  events:
    purge:
      enabled: true
      cron: "0 10 4 * * *"      # 每天 04:10 清一次（可調）
      retentionDays: 45         # 留存 45 天（promotion 只看 45 天）
      batchSize: 50000          # 依你資料量調整（1~10萬都可）
      maxTotalPerRun: 1000000   # 新增：單次 run 總上限
      pauseMsBetweenBatches: 50 # 新增：批次間暫停，降低鎖壓力

logging:
  level:
    org.springframework.scheduling: INFO
    com.calai.backend.workout.job: INFO

workout:
  estimate:
    blacklistPolicy: block   # 可選：generic（現狀）、block（阻擋）、audit（只記錄與回傳 not_found）

springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
